import json
import re
import csv

from datetime import datetime
from collections import defaultdict

import pymysql.cursors
import pandas as pd


connection = ()
cursor = connection.cursor()

with open('/Users/har/py/git/others/data_import/all_tag_data.json', 'r') as f:
    all_tag_data = json.load(f)


cursor.execute('''select id, name from app_4_tag order by id;''')
rows = cursor.fetchall()
tagid_name = {}
for row in rows:
    tagid_name[row['id']] = row['name']
# print(tagid_name[4656])


cursor.execute('''select id, name, group_type from app_4_taggroup order by id;''')
rows = cursor.fetchall()
tag_group_data = {}
for row in rows:
    tag_group_data[row['id']] = row['group_type']

cursor.execute('''select id, tag_id, tag_group_id from app_4_taggroupmembers where id <2551 order by id;''')
rows = cursor.fetchall()
i = 0
compare_set = set()
compare_list = [4000, 4001, 4002, 4003, 4004, 4005, 4007, 4009, 4010, 4012, 4013, 4014, 4015, 4017, 4018, 4020, 4021, 4022, 4023, 4024, 4026, 4027, 4028, 4030, 4031, 4032, 4033, 4034, 4035, 4040, 4041, 4042, 4045, 4046, 4047, 4048, 4049, 4050, 4051, 4053, 4054, 4055, 4057, 4059, 4061, 4062, 4065, 4066, 4067, 4068, 4069, 4070, 4071, 4072, 4073, 4074, 4076, 4079, 4080, 4081, 4082, 4083, 4084, 4086, 4087, 4088, 4090, 4091, 4093, 4094, 4095, 4096, 4097, 4098, 4100, 4101, 4102, 4103, 4104, 4105, 4106, 4108, 4109, 4110, 4111, 4112, 4113, 4114, 4115, 4116, 4117, 4118, 4119, 4120, 4121, 4122, 4123, 4124, 4125, 4126, 4127, 4128, 4129, 4130, 4131, 4132, 4133, 4134, 4135, 4136, 4137, 4138, 4139, 4140, 4141, 4142, 4143, 4144, 4145, 4146, 4147, 4148, 4149, 4150, 4151, 4152, 4153, 4154, 4155, 4156, 4157, 4158, 4159, 4160, 4161, 4162, 4163, 4164, 4165, 4166, 4167, 4168, 4169, 4170, 4171, 4172, 4173, 4174, 4175, 4176, 4177, 4179, 4180, 4181, 4182, 4183, 4184, 4185, 4186, 4187, 4188, 4189, 4190, 4191, 4192, 4193, 4194, 4195, 4196, 4197, 4198, 4199, 4200, 4201, 4202, 4203, 4209, 4210, 4211, 4212, 4213, 4214, 4215, 4216, 4217, 4218, 4219, 4220, 4221, 4222, 4223, 4224, 4225, 4226, 4227, 4228, 4229, 4230, 4231, 4232, 4235, 4236, 4237, 4238, 4239, 4240, 4241, 4242, 4243, 4244, 4245, 4246, 4247, 4248, 4249, 4250, 4251, 4252, 4253, 4254, 4255, 4256, 4257, 4258, 4259, 4260, 4261, 4266, 4268, 4269, 4270, 4271, 4280, 4281, 4283, 4284, 4285, 4286, 4287, 4288, 4289, 4290, 4291, 4292, 4295, 4296, 4297, 4298, 4299, 4300, 4301, 4302, 4307, 4308, 4309, 4310, 4331, 4332, 4333, 4334, 4350, 4371, 4372, 4373, 4374, 4375, 4376, 4377, 4378, 4379, 4380, 4381, 4382, 4384, 4385, 4386, 4387, 4388, 4389, 4402, 4403, 4404, 4405, 4406, 4407, 4408, 4409, 4410, 4411, 4412, 4413, 4414, 4415, 4416, 4417, 4418, 4419, 4420, 4421, 4422, 4423, 4424, 4425, 4426, 4427, 4428, 4429, 4430, 4431, 4432, 4433, 4434, 4435, 4436, 4437, 4438, 4439, 4440, 4441, 4442, 4443, 4444, 4445, 4446, 4447, 4448, 4449, 4450, 4451, 4452, 4453, 4454, 4455, 4456, 4457, 4458, 4459, 4460, 4461, 4462, 4463, 4464, 4465, 4506, 4507, 4508, 4509, 4510, 4511, 4512, 4513, 4514, 4515, 4516, 4517, 4518, 4519, 4520, 4521, 4522, 4523, 4524, 4525, 4526, 4527, 4528, 4531, 4532, 4533, 4534, 4535, 4536, 4537, 4538, 4539, 4540, 4541, 4542, 4547, 4548, 4549, 4550, 4551, 4552, 4553, 4554, 4555, 4556, 4581, 4582, 4583, 4603, 4604, 4605, 4606, 4607, 4608, 4609, 4610, 4611, 4612, 4613, 4614, 4615, 4616, 4617, 4618, 4619, 4620, 4621, 4622, 4623, 4624, 4625, 4626, 4627, 4628, 4636, 4638, 4640, 4641, 4642, 4643, 4644, 4645, 4646, 4647, 4648, 4649, 4650, 4651, 4652, 4653, 4654, 4655, 4656, 4657, 4658, 4661, 4664, 4665, 4667, 4668, 4677, 4680, 4681, 4682, 4698, 4699, 4700, 4701, 4702, 4703, 4704, 4705, 4706, 4707, 4708, 4709, 4710, 4711, 4712, 4713, 4714, 4715, 4716, 4717, 4718, 4719, 4720, 4721, 4722, 4723, 4724, 4725, 4726, 4727, 4728, 4729, 4730, 4731, 4732, 4733, 4734, 4735, 4736, 4737, 4738, 4739, 4740, 4741, 4742, 4743, 4744, 4745, 4746, 4747, 4748, 4749, 4750, 4751, 4752, 4753, 4754, 4755, 4756, 4757, 4758, 4759, 4760, 4808, 4809, 4810, 4811, 4812, 4813, 4814, 4815, 4816, 4817, 4818, 4819, 4820, 4821, 4822, 4823, 4824, 4825, 4826, 4827, 4828, 4829, 4830, 4831, 4832, 4833, 4834, 4835, 4836, 4837, 4838, 4839, 4840, 4841, 4842, 4843, 4844, 4845, 4846, 4847, 4848, 4849, 4850, 4851, 4852, 4853, 4854, 4855, 4856, 4857, 4858, 4859, 4860, 4861, 4882, 4883, 4884, 4885, 4886, 4887, 4888, 4889, 4890, 4891, 4892, 4895, 4896, 4898, 5009, 5010, 5011]
compare_dict = defaultdict(list)
for row in rows:
    '''
{'id': 1, 'tag_id': 4656, 'tag_group_id': 2153}
{'id': 2, 'tag_id': 4656, 'tag_group_id': 2176}
{'id': 3, 'tag_id': 4657, 'tag_group_id': 2153}'''

    temp = tagid_name[row['tag_id']]
    cms_data_type = tag_group_data[row['tag_group_id']] # 取出实际库中tag_id 对应 tag_group_id的类型
    if cms_data_type == 4:
        continue

    try:
        temp =  all_tag_data[temp]# 取出tag_id在all_tag_data中的类型
    except KeyError:
        continue

    real_data_type = temp['类型']
    if real_data_type != cms_data_type:
        i +=1
        compare_set.add(row['tag_id'])
        compare_dict[row['tag_id']].append(row['tag_group_id'])
        # print('''delete from app_4_taggroupmembers where id={};'''.format(row['id']))
        # print(row)

print(i)
# print(set(compare_list) - compare_set)
# print(compare_set - set(compare_list))
# print(compare_dict[4000])

# with open('/Users/har/py/git/others/data_import/compare.csv', 'r') as f:
#     for line in f:
#         id, count = line.split(',')
#         if not len(compare_dict[int(id)]) == int(count):
#             print(id, len(compare_dict[int(id)]), count)
